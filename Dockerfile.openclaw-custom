FROM coollabsio/openclaw:latest

# OpenClaw's built-in skill installer expects `bun` to be available
# (e.g. "Install mcporter (bun)"). The upstream runtime image does not ship bun,
# so we add it in this derived image for Coolify deployments.
RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    ffmpeg \
    python3 \
    python3-pip \
    python3-venv \
  && rm -rf /var/lib/apt/lists/*

RUN curl -fsSL https://bun.sh/install | bash \
  && ln -sf /root/.bun/bin/bun /usr/local/bin/bun \
  && ln -sf /root/.bun/bin/bunx /usr/local/bin/bunx

# Provide the `whisper` CLI for the built-in OpenAI Whisper skill.
# This is a heavy dependency (pulls torch CPU wheels), but it makes the
# "Missing: bin:whisper" requirement pass inside the container.
RUN python3 -m venv /opt/whisper-venv \
  && /opt/whisper-venv/bin/pip install --no-cache-dir --prefer-binary openai-whisper \
  && ln -sf /opt/whisper-venv/bin/whisper /usr/local/bin/whisper

# Coolify deployment cannot reliably bind-mount individual files from the repo
# into the container. Bake the updated scripts into a derived image instead.
COPY scripts/entrypoint.sh /app/scripts/entrypoint.sh
COPY scripts/configure.js /app/scripts/configure.js

RUN chmod +x /app/scripts/entrypoint.sh
